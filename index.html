<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2PPro.in - Decentralized Crypto Exchange</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo-600 */
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        .btn-secondary {
            background-color: #e0e7ff; /* Indigo-100 */
            color: #4f46e5; /* Indigo-600 */
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #c7d2fe; /* Indigo-200 */
        }
        input[type="text"], input[type="number"], textarea {
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.75rem;
            width: 100%;
            font-size: 1rem;
            line-height: 1.5;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: #6366f1; /* Indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Indigo-500 with opacity */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-indigo-700 text-white shadow-md py-4">
        <div class="container flex justify-between items-center">
            <h1 class="text-3xl font-bold">P2PPro.in</h1>
            <nav>
                <ul class="flex space-x-6">
                    <li><a href="#home" class="hover:text-indigo-200 transition-colors">Home</a></li>
                    <li><a href="#offers" class="hover:text-indigo-200 transition-colors">Offers</a></li>
                    <li><a href="#create-offer" class="hover:text-indigo-200 transition-colors">Create Offer</a></li>
                    <li><a href="#about" class="hover:text-indigo-200 transition-colors">About</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container py-8">

        <!-- Introduction Section -->
        <section id="home" class="card text-center">
            <h2 class="text-4xl font-extrabold text-gray-900 mb-4">India's Decentralized Crypto-to-Fiat Exchange</h2>
            <p class="text-lg text-gray-700 mb-6 max-w-3xl mx-auto">
                P2PPro.in bridges the gap between stablecoins (like USDC) and Indiaâ€™s fiat ecosystem through a peer-to-peer (P2P) swap protocol. Fast, low-cost, compliant, and user-friendly.
            </p>
            <div class="flex flex-wrap justify-center gap-4">
                <button class="btn-primary">Connect Wallet</button>
                <button class="btn-secondary">Learn More</button>
            </div>
        </section>

        <!-- User & Wallet Status -->
        <section class="card">
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Wallet & User Status</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <p class="text-gray-600 mb-2"><strong>Authentication Status:</strong> <span id="authStatus" class="font-medium text-red-500">Not Authenticated</span></p>
                    <p class="text-gray-600 mb-2"><strong>Your User ID:</strong> <span id="userIdDisplay" class="font-mono text-sm text-gray-700 break-all">Loading...</span></p>
                </div>
                <div>
                    <p class="text-gray-600 mb-2"><strong>Phantom Wallet:</strong> <span id="phantomStatus" class="font-medium text-yellow-600">Disconnected</span></p>
                    <p class="text-gray-600 mb-2"><strong>Solana Network:</strong> <span id="solanaStatus" class="font-medium text-gray-500">Not Connected</span></p>
                </div>
            </div>
        </section>

        <!-- Offers Section -->
        <section id="offers" class="card">
            <h3 class="text-2xl font-semibold text-gray-800 mb-6">Live P2P Offers</h3>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Buy Offers -->
                <div>
                    <h4 class="text-xl font-medium text-gray-700 mb-4">Buy USDC Offers (Sell INR for USDC)</h4>
                    <div id="buyOffersList" class="space-y-4">
                        <!-- Example Buy Offer -->
                        <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                            <p class="font-semibold text-lg text-gray-800">Selling INR 85,000 for 1000 USDC</p>
                            <p class="text-sm text-gray-600">Rate: 85 INR/USDC</p>
                            <p class="text-sm text-gray-600">Seller: @crypto_trader_001</p>
                            <button class="btn-primary text-sm mt-3">Buy USDC</button>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                            <p class="font-semibold text-lg text-gray-800">Selling INR 4,250 for 50 USDC</p>
                            <p class="text-sm text-gray-600">Rate: 85 INR/USDC</p>
                            <p class="text-sm text-gray-600">Seller: @user_xyz</p>
                            <button class="btn-primary text-sm mt-3">Buy USDC</button>
                        </div>
                        <p id="noBuyOffers" class="text-gray-500 text-center hidden">No buy offers available yet.</p>
                    </div>
                </div>

                <!-- Sell Offers -->
                <div>
                    <h4 class="text-xl font-medium text-gray-700 mb-4">Sell USDC Offers (Buy INR with USDC)</h4>
                    <div id="sellOffersList" class="space-y-4">
                        <!-- Example Sell Offer -->
                        <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                            <p class="font-semibold text-lg text-gray-800">Buying INR 17,000 with 200 USDC</p>
                            <p class="text-sm text-gray-600">Rate: 85 INR/USDC</p>
                            <p class="text-sm text-gray-600">Buyer: @fiat_seeker_india</p>
                            <button class="btn-primary text-sm mt-3">Sell USDC</button>
                        </div>
                        <p id="noSellOffers" class="text-gray-500 text-center hidden">No sell offers available yet.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Create Offer Section -->
        <section id="create-offer" class="card">
            <h3 class="text-2xl font-semibold text-gray-800 mb-6">Create a New Offer</h3>
            <form id="createOfferForm" class="space-y-4">
                <div>
                    <label for="offerType" class="block text-sm font-medium text-gray-700 mb-1">Offer Type</label>
                    <select id="offerType" name="offerType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="buy">Buy USDC (Sell INR)</option>
                        <option value="sell">Sell USDC (Buy INR)</option>
                    </select>
                </div>
                <div>
                    <label for="usdcAmount" class="block text-sm font-medium text-gray-700 mb-1">USDC Amount</label>
                    <input type="number" id="usdcAmount" name="usdcAmount" placeholder="e.g., 100" class="mt-1" required min="1">
                </div>
                <div>
                    <label for="inrAmount" class="block text-sm font-medium text-gray-700 mb-1">INR Amount</label>
                    <input type="number" id="inrAmount" name="inrAmount" placeholder="e.g., 8500" class="mt-1" required min="1">
                </div>
                <div>
                    <label for="telegramUsername" class="block text-sm font-medium text-gray-700 mb-1">Your Telegram Username (On-chain ID)</label>
                    <input type="text" id="telegramUsername" name="telegramUsername" placeholder="@your_username" class="mt-1" required>
                </div>
                <button type="submit" class="btn-primary w-full">Post Offer</button>
            </form>
        </section>

        <!-- Additional Features Section -->
        <section id="about" class="card">
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">More About P2PPro.in</h3>
            <div class="space-y-4 text-gray-700">
                <p><strong>Escrow-backed USDC Swaps:</strong> Trustless transfers via Anchor smart contracts ensure security for both parties.</p>
                <p><strong>UPI + QR Code Payment Integration:</strong> Seamless fiat integration for merchant and retail adoption across India.</p>
                <p><strong>Telegram Username On-chain ID:</strong> Your Telegram username acts as your secure on-chain identity for easy communication and transaction tracking.</p>
                <p><strong>Why This Matters:</strong> India is home to 115M+ crypto users, yet on/off-ramping remains broken and centralized. We provide a compliant, user-friendly, and scalable crypto-rail for India.</p>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-8">
        <div class="container text-center text-gray-400">
            <p>&copy; 2025 P2PPro.in. All rights reserved.</p>
            <p class="mt-2">Connecting India to Web3, one swap at a time.</p>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-p2ppro-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = 'loading...'; // Placeholder for user ID

        const authStatusElement = document.getElementById('authStatus');
        const userIdDisplayElement = document.getElementById('userIdDisplay');
        const buyOffersList = document.getElementById('buyOffersList');
        const sellOffersList = document.getElementById('sellOffersList');
        const noBuyOffers = document.getElementById('noBuyOffers');
        const noSellOffers = document.getElementById('noSellOffers');
        const createOfferForm = document.getElementById('createOfferForm');

        // Initialize Firebase and set up authentication
        const initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Cannot initialize Firebase.");
                    authStatusElement.textContent = 'Firebase Config Missing';
                    authStatusElement.classList.remove('text-red-500');
                    authStatusElement.classList.add('text-yellow-600');
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for authentication state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusElement.textContent = 'Authenticated';
                        authStatusElement.classList.remove('text-red-500', 'text-yellow-600');
                        authStatusElement.classList.add('text-green-600');
                        userIdDisplayElement.textContent = userId;
                        console.log("User authenticated:", userId);

                        // Once authenticated, load offers
                        loadOffers();
                    } else {
                        userId = 'Not authenticated';
                        authStatusElement.textContent = 'Not Authenticated';
                        authStatusElement.classList.remove('text-green-600', 'text-yellow-600');
                        authStatusElement.classList.add('text-red-500');
                        userIdDisplayElement.textContent = 'Please sign in.';
                        console.log("User not authenticated.");
                        // Attempt anonymous sign-in if no initial token
                        if (!initialAuthToken) {
                            signInAnonymously(auth).then(() => {
                                console.log("Signed in anonymously.");
                            }).catch((error) => {
                                console.error("Error signing in anonymously:", error);
                            });
                        }
                    }
                });

                // Sign in with custom token if available, otherwise anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

            } catch (error) {
                console.error("Error initializing Firebase or during authentication:", error);
                authStatusElement.textContent = 'Error during Auth';
                authStatusElement.classList.remove('text-green-600');
                authStatusElement.classList.add('text-red-500');
            }
        };

        // Function to load offers from Firestore
        const loadOffers = () => {
            if (!db || !userId || userId === 'loading...' || userId === 'Not authenticated') {
                console.log("Firestore not ready or user not authenticated. Cannot load offers.");
                return;
            }

            // Public data collection for offers
            const offersCollectionRef = collection(db, `artifacts/${appId}/public/data/offers`);

            // Use onSnapshot for real-time updates
            onSnapshot(offersCollectionRef, (snapshot) => {
                const offers = [];
                snapshot.forEach(doc => {
                    offers.push({ id: doc.id, ...doc.data() });
                });
                displayOffers(offers);
            }, (error) => {
                console.error("Error fetching offers:", error);
            });
        };

        // Function to display offers
        const displayOffers = (offers) => {
            buyOffersList.innerHTML = '';
            sellOffersList.innerHTML = '';

            const buyOffers = offers.filter(offer => offer.offerType === 'buy');
            const sellOffers = offers.filter(offer => offer.offerType === 'sell');

            if (buyOffers.length === 0) {
                noBuyOffers.classList.remove('hidden');
            } else {
                noBuyOffers.classList.add('hidden');
                buyOffers.forEach(offer => {
                    const offerElement = createOfferCard(offer, 'buy');
                    buyOffersList.appendChild(offerElement);
                });
            }

            if (sellOffers.length === 0) {
                noSellOffers.classList.remove('hidden');
            } else {
                noSellOffers.classList.add('hidden');
                sellOffers.forEach(offer => {
                    const offerElement = createOfferCard(offer, 'sell');
                    sellOffersList.appendChild(offerElement);
                });
            }
        };

        // Helper to create an offer card HTML
        const createOfferCard = (offer, type) => {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200';
            div.innerHTML = `
                <p class="font-semibold text-lg text-gray-800">${type === 'buy' ? 'Selling INR' : 'Buying INR'} ${offer.inrAmount} for ${offer.usdcAmount} USDC</p>
                <p class="text-sm text-gray-600">Rate: ${(offer.inrAmount / offer.usdcAmount).toFixed(2)} INR/USDC</p>
                <p class="text-sm text-gray-600">User: @${offer.telegramUsername}</p>
                <button class="btn-primary text-sm mt-3">${type === 'buy' ? 'Buy USDC' : 'Sell USDC'}</button>
            `;
            // Add a click listener to the button (for simulation)
            div.querySelector('button').addEventListener('click', () => {
                showMessageBox(`You clicked to ${type === 'buy' ? 'buy' : 'sell'} ${offer.usdcAmount} USDC from @${offer.telegramUsername}. (This is a simulation, no actual transaction occurred.)`);
            });
            return div;
        };

        // Handle form submission for creating a new offer
        createOfferForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !userId || userId === 'loading...' || userId === 'Not authenticated') {
                showMessageBox("Please authenticate to create an offer.");
                return;
            }

            const offerType = document.getElementById('offerType').value;
            const usdcAmount = parseFloat(document.getElementById('usdcAmount').value);
            const inrAmount = parseFloat(document.getElementById('inrAmount').value);
            const telegramUsername = document.getElementById('telegramUsername').value.replace('@', ''); // Remove '@' if present

            if (isNaN(usdcAmount) || isNaN(inrAmount) || usdcAmount <= 0 || inrAmount <= 0 || !telegramUsername) {
                showMessageBox("Please enter valid amounts and your Telegram username.");
                return;
            }

            const newOffer = {
                offerType,
                usdcAmount,
                inrAmount,
                telegramUsername,
                createdAt: new Date().toISOString(),
                userId: userId // Associate offer with the user who created it
            };

            try {
                // Add offer to the public collection
                await addDoc(collection(db, `artifacts/${appId}/public/data/offers`), newOffer);
                showMessageBox("Offer posted successfully!");
                createOfferForm.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessageBox("Failed to post offer. Please try again.");
            }
        });

        // Custom Message Box (instead of alert)
        const showMessageBox = (message) => {
            const messageBox = document.createElement('div');
            messageBox.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50';
            messageBox.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center">
                    <p class="text-lg text-gray-800 mb-4">${message}</p>
                    <button id="closeMessageBox" class="btn-primary">OK</button>
                </div>
            `;
            document.body.appendChild(messageBox);

            document.getElementById('closeMessageBox').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        };

        // Initialize Firebase when the window loads
        window.onload = initializeFirebase;

    </script>
</body>
</html>
